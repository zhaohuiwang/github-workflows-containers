.ONESHELL:
## with .ONESHELL: the lines in the recipe will be passed to a single invocation of the shell. The following PYTHON and PIP variables ensure 

# put this python-project-template directory to the same level or your project, execute this following command
# make --file=Makefile_init_pyproject project-name="demo-project" init-project

# afterwards you may cd project-name, and start to add dependencies.

# in shell predefine the project-name variable or pass as argument as
# notice the variable name with hyphen or underscore
# make project-name="demo-project" init-project # YES, preferree
# make project_name="demo-project" init-project # YES, name need to be updated
# project-name="demo-project" make init-project # NO
# project_name="demo-project" make init-project	# YES, name need to be updated

PROJECTNAME = $(project-name) 

USERNAME = $(shell whoami)
PWD = $(shell pwd)

##################
## Setup ##
##################

.PHONY: check-poetry
check-poetry:
ifeq ($(shell which poetry), )
	$(error "Can't find poetry on the PATH. Please run 'make install-poetry' or update PATH")
else
	@poetry --version
	@echo $(USERNAME) is initiating the $(PROJECTNAME) project in $(PROJECTNAME) directory.
endif


.PHONY: install-poetry
install-poetry:
	@curl -sSL https://install.python-poetry.org | python3 -

.PHONY: init-project
init-project:  check-poetry
## create and cd the project directory -- parent dir.
	@mkdir $(PROJECTNAME) && cd $(PROJECTNAME)
## now initiate the repository/package wiht poetry
	@poetry new $(PROJECTNAME) --src --name $(PROJECTNAME)

# create the commom dir and files. The -p option (parent) allow you to create a directory hierarchy in one step. '.github/workflows/' for YAML (.yml) config files
	@mkdir notebooks -p data/input data/.images .github/workflows
	@touch README.md LICENSE.txt .CHANGELOG.md
	@mkdir docs && cp ../Makefile_init_pyproject docs/

# initiate gitignore file
	@cd $(PROJECTNAME)
	@touch ../.gitignore
	@echo ${PROJECTNAME}/poetry.lock | tr -d ' ' >> ../.gitignore
	@echo $(PROJECTNAME)/poetry.toml | tr -d ' ' >> ../.gitignore
	@echo ".CHANGELOG.md/\notebooks/\ndata/" >> ../.gitignore
# echo "$string" | tr -d '[:space:]'  removes all white spaces
	@echo .venv >> ../.gitignore

# poetry config need to be executed in the project repository directory. poetry will still search ~/${USERNAME}/.cache/pypoetry/virtualenvs for a existing venv pertaining to this project. Only if not found it will create one in /${PROJECTNAME}/${PROJECTNAME}/.venv
	@poetry config virtualenvs.in-project true --local

# initiate the venv with common packages
	@poetry add ipykernel pytest --group test



